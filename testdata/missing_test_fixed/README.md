A fixed and better-tested version of the code from `missing_test`.
